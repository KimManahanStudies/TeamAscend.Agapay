@{
    Layout = "_BackEndLayout";
    ViewData["Title"] = "Dashboard";
}
<style>
    #event-calendar h2{
        font-size: 20px;
    }

    .fc .fc-daygrid-day-frame {
        min-height: unset;
        height: 40px;
    }

    .fc .fc-scroller-harness-liquid {
        height: 270px !important;
    }

    .fc .fc-view-harness {
        height: 310px !important;
    }

    .fc-scroller.fc-scroller-liquid-absolute {
        overflow:visible !important;
    }

    .location-popup-mini {
        max-width: 250px;
    }
    .location-popup-mini h4 {
        margin: 0 0 5px 0;
        color: #003366;
        font-size: 14px;
    }
    .location-popup-mini p {
        margin: 3px 0;
        font-size: 12px;
    }
    .location-popup-mini .type-badge {
        display: inline-block;
        padding: 1px 6px;
        background-color: #e8f4f8;
        color: #003366;
        border-radius: 10px;
        font-size: 11px;
        margin-bottom: 5px;
    }
</style>
<!-- Page Heading -->
@* <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
    <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
        <i class="fas fa-download fa-sm text-white-50"></i> Generate Report
    </a>
</div> *@

<!-- Content Row -->
<div class="row">

    <!-- Area Chart -->
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
            <!-- Card Header - Dropdown -->
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Live Weather Map</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-chevron-down fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                         aria-labelledby="dropdownMenuLink">
                        <div class="dropdown-header">Live Map Views:</div>
                        <a class="dropdown-item" href="#" onclick="changeMap('wind')">Wind</a>
                        <a class="dropdown-item" href="#" onclick="changeMap('waves')">Waves</a>
                        <a class="dropdown-item" href="#" onclick="changeMap('current')">Current</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" onclick="changeMap('other')">Other Live Map Views</a>
                    </div>
                </div>
            </div>

            <!-- Card Body -->
            <div class="card-body">
                <div class="chart-area">
                    <iframe 
                        id="liveMapFrame"
                        src="https://earth.nullschool.net/#2025/09/11/1700Z/wind/surface/level/grid=on/orthographic=-240.33,12.22,1716/loc=121.054,14.616"
                        frameborder="0" 
                        style="height:100%; width:100%;">
                    </iframe>
                </div>
            </div>
        </div>
    </div>


    <!-- Pie Chart -->
    <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
           @*  <!-- Card Header - Dropdown -->
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Calendar</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                         aria-labelledby="dropdownMenuLink">
                        <div class="dropdown-header">Dropdown Header:</div>
                        <a class="dropdown-item" href="#">Action</a>
                        <a class="dropdown-item" href="#">Another action</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Something else here</a>
                    </div>
                </div>
            </div> *@
            <!-- Card Body -->
            <div class="card-body">
                <div class="">
                    <div id="event-calendar"></div>
                </div>
                @* <div class="mt-4 text-center small">
                    <span class="mr-2">
                        <i class="fas fa-circle text-primary"></i> Direct
                    </span>
                    <span class="mr-2">
                        <i class="fas fa-circle text-success"></i> Social
                    </span>
                    <span class="mr-2">
                        <i class="fas fa-circle text-info"></i> Referral
                    </span>
                </div> *@
            </div>
        </div>
    </div>
</div>

<!-- Content Row -->
<div class="row">

    <!-- Content Column -->
    <div class="col-lg-6 mb-4">

        <!-- Project Card Example -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Resource Locator</h6>
            </div>
            <div class="card-body">
                <div id="rmap" style="height:330px;width:100%">

                </div>
            </div>
        </div>

        <!-- Color System -->
        <div class="row">
            <!-- Registered Users (First Row - Full Width) -->
            <div class="col-lg-12 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Registered Users
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">1,250</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-users fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Evacuation Sites (Second Row - Full Width) -->
            <div class="col-lg-12 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Evacuation Sites
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">35</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-home fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="col-lg-6 mb-4">

        <!-- Illustrations -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Mobile Info Ads</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink2"
                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                         aria-labelledby="dropdownMenuLink">
                        <div class="dropdown-header">Dropdown Header:</div>
                        <a class="dropdown-item" href="#">Action</a>
                        <a class="dropdown-item" href="#">Another action</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Something else here</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <img class="" style="width: 100%; margin: 5px 0px;"
                         src="~/imgs/info_ad1.jpg" alt="">
                </div>
                <p>
                    Add some quality, svg illustrations to your project courtesy of <a target="_blank" rel="nofollow" href="https://undraw.co/">unDraw</a>, a
                    constantly updated collection of beautiful svg images that you can use
                    completely free and without attribution!
                </p>
                <a target="_blank" rel="nofollow" href="https://undraw.co/">
                    Browse Illustrations on
                    unDraw &rarr;
                </a>
            </div>
        </div>

    </div>
</div>

<!-- Content Row -->

@section Scripts {
    <link href="~/lib/leafletjs/leaflet.css" rel="stylesheet" />
    <script src="~/js/fullcalendar.js"></script>
    <script src="~/lib/leafletjs/leaflet.js"></script>
    <script>
        let dashboardMap;
        let dashboardMarkers = [];
        
        function createMiniPopup(location) {
            return `
                <div class="location-popup-mini">
                    <h4>${location.Name}</h4>
                    <span class="type-badge">${location.LocationType}</span>
                    <p><i class="fas fa-map-marker-alt mr-1"></i>${location.Address}</p>
                </div>`;
        }

        function initMap() {
            // Default to Manila coordinates
            const defaultPosition = [14.5995, 120.9842];

            // Initialize the map
            dashboardMap = L.map('rmap').setView(defaultPosition, 11);

            // Add the OpenStreetMap tiles
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(dashboardMap);

            // Try to get user's location
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    dashboardMap.setView([position.coords.latitude, position.coords.longitude], 11);
                });
            }

            // Load locations
            loadDashboardLocations();
        }

        function loadDashboardLocations() {
            $.ajax({
                url: '/Resources/GetAllLocations',
                method: 'GET',
                success: function(locations) {
                    updateDashboardMarkers(locations);
                },
                error: function(err) {
                    console.error('Error loading locations:', err);
                }
            });
        }

        function updateDashboardMarkers(locations) {
            // Clear existing markers
            dashboardMarkers.forEach(marker => dashboardMap.removeLayer(marker));
            dashboardMarkers = [];

            // Add markers for each location
            locations.forEach(location => {
                if (location.MapCoordinates) {
                    const [lat, lng] = location.MapCoordinates.split(',');
                    const marker = L.marker([parseFloat(lat), parseFloat(lng)])
                        .bindPopup(createMiniPopup(location));
                    
                    marker.addTo(dashboardMap);
                    dashboardMarkers.push(marker);
                }
            });

            // Adjust map view to show all markers
            if (dashboardMarkers.length > 0) {
                const group = new L.featureGroup(dashboardMarkers);
                dashboardMap.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function initCalendar() {
            var eventCal = document.getElementById('event-calendar');
            var eventCalendar = new FullCalendar.Calendar(eventCal, {
                editable: false,
            });
            eventCalendar.render();
        }

        $(function(){
            initCalendar();
            initMap();

            // Ensure map renders correctly in card
            $('.nav-tabs a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                dashboardMap.invalidateSize();
            });
        });
        // Live Map
        function changeMap(type) {
            const iframe = document.getElementById('liveMapFrame');
            switch (type) {
                case 'wind':
                    iframe.src = "https://earth.nullschool.net/#2025/09/11/1700Z/wind/surface/level/grid=on/orthographic=-240.33,12.22,1716/loc=110.152,26.474";
                    break;
                case 'waves':
                    iframe.src = "https://earth.nullschool.net/#2025/09/11/1700Z/wind/primary/waves/overlay=wind/grid=on/orthographic=-240.33,12.22,1716/loc=110.152,26.474";
                    break;
                case 'current':
                    iframe.src = "https://earth.nullschool.net/#2025/09/11/1700Z/wind/surface/currents/overlay=wind/grid=on/orthographic=-240.33,12.22,1716/loc=110.152,26.474";
                    break;
                case 'other':
                    window.open("https://earth.nullschool.net/#2025/09/11/1700Z/wind/surface/level/grid=on/orthographic=-240.33,12.22,1716/loc=115.760,14.063", "_blank");
                    break;
            }
        }
    </script>
}