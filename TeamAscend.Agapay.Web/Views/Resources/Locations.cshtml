@model List<TeamAscend.Agapay.Web.Models.MapLocation>
@{
    Layout = "_BackEndLayout";
    ViewData["Title"] = "Location Pins";
}
@section Header
{
    <!-- Custom styles for this page -->
    <link href="/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
    <link href="~/lib/leafletjs/leaflet.css" rel="stylesheet" />
}
<form id="frmDetails" method="post" action="~/Resources/SaveLocation" autocomplete="off">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Location Pins</h1>
        <div>
            <a href="/Admin/Map" class="btn btn-info btn-icon-split shadow mr-2">
                <span class="icon text-white-50">
                    <i class="fas fa-map"></i>
                </span>
                <span class="text">Map View</span>
            </a>
            <button class="btn btn-primary btn-icon-split shadow" type="button" id="btnNewLocation">
                <span class="icon text-white-50">
                    <i class="fas fa-map-marker-alt"></i>
                </span>
                <span class="text">New Location</span>
            </button>
        </div>        
    </div>

    <!-- DataTables -->
    <div class="card shadow" style="padding:10px">
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Type</th>  <!-- Added LocationType column -->
                        @* <th>Address</th> *@
                        @* <th>Coordinates</th> *@
                        @* <th>Created Date</th> *@
                        <th>Modified Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var location in Model)                
                    {
                        <tr>
                            <td>@location.ID</td>
                            <td>@location.Name</td>
                            <td>@location.LocationType</td>  <!-- Added LocationType data -->
                            @* <td>@location.Address</td> *@
                            @* <td>@location.MapCoordinates</td> *@
                            @* <td>@location.CreatedDate</td> *@
                            <td>@location.ModifiedDate</td>
                            <td>
                                <a href="#" class="text-success" title="Edit" onclick="EditLocation(@location.ID)">
                                    <i class="fa fa-edit"></i>
                                </a>
                                <a href="#" class="text-danger" title="Delete" onclick="DeleteLocation(@location.ID)">
                                    <i class="fa fa-times"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Location Modal -->
    <div class="modal fade right" id="locationModal" tabindex="-1" role="dialog" aria-labelledby="locationModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalLabel">Location Details</h5>
                    <span style="float:right">
                        <button class="btn btn-primary" type="submit">Save</button>
                        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    </span>                    
                </div>
                <div class="modal-body">
                    <input type="hidden" id="ID" name="ID" />
                    
                    <!-- Name and Type -->
                    <div class="row gx-3 mb-3">
                        <div class="col-md-6">
                            <label class="small mb-1" for="Name">Location Name</label>
                            <input class="form-control" id="Name" name="Name" type="text" placeholder="Enter location name" required/>
                        </div>
                        <div class="col-md-6">
                            <label class="small mb-1" for="LocationType">Location Type</label>
                            <select class="form-control" id="LocationType" name="LocationType" required>
                                <option value="">Select type...</option>
                                <option value="Hospital">Hospital</option>
                                <option value="Supply Store">Supply Store</option>
                                <option value="Evacuation Site">Evacuation Site</option>
                                <option value="Government Centers">Government Centers</option>
                                <option value="Relief Warehouse">Relief Warehouse</option>
                                <option value="Water Refill Station">Water Refill Station</option>
                                <option value="Police">Police Station</option>
                                <option value="Fire">Fire Station</option>
                                <option value="Shelter">Shelter</option>
                                <option value="Others">Danger</option>
                            </select>
                        </div>
                    </div>
                    <div class="row gx-3 mb-3">
                        <div class="col-md-12">
                            <label class="small mb-1" for="Address">Address</label>
                            <input class="form-control" id="Address" name="Address" type="text" placeholder="Enter address" required/>
                        </div>
                    </div>

                    <!-- Coordinates -->
                    <div class="row gx-3 mb-3">
                        <div class="col-md-12">
                            <label class="small mb-1" for="MapCoordinates">Map Coordinates</label>
                            <input class="form-control" id="MapCoordinates" name="MapCoordinates" type="text" 
                                   placeholder="Click on map to set coordinates" readonly required/>
                            <div id="mapPinLocator" style="width:100%;height:300px;margin-top:10px;">
                            </div>
                        </div>                        
                    </div>

                    <!-- Description -->
                    <div class="row gx-3 mb-3">
                        <div class="col-md-12">
                            <label class="small mb-1" for="Description">Description</label>
                            <textarea class="form-control" id="Description" name="Description" rows="3" placeholder="Enter location description" required></textarea>
                        </div>
                    </div>

                    <!-- Extra Details -->
                    <div class="row gx-3 mb-3" style="display:none">
                        <div class="col-md-12">
                            <label class="small mb-1" for="ExtraDetails">Additional Details</label>
                            <textarea class="form-control" id="ExtraDetails" name="ExtraDetails" rows="3" placeholder="Enter additional details" required>EXTRA</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <script src="~/lib/leafletjs/leaflet.js"></script>
    <script>
        let map;
        let marker;
        
        function initializeMap() {
            // Default to Manila coordinates if geolocation fails
            const defaultPosition = [14.5995, 120.9842];

            // Initialize the map
            map = L.map('mapPinLocator').setView(defaultPosition, 13);

            // Add the OpenStreetMap tiles
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Try to get user's location
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    map.setView([userLat, userLng], 13);
                });
            }

            // Handle map clicks
            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                
                // Remove existing marker if any
                if (marker) {
                    map.removeLayer(marker);
                }
                
                // Add new marker
                marker = L.marker([lat, lng]).addTo(map);
                
                // Update coordinates input
                $('#MapCoordinates').val(`${lat},${lng}`);
            });
        }

        function NewLocation(){
            $('#ID').val(0);
            $('#frmDetails').trigger('reset');
            $('#locationModal').modal('show');
            
            // Initialize map after modal is shown
            $('#locationModal').on('shown.bs.modal', function () {
                setTimeout(function() {
                    map.invalidateSize();
                    if (marker) {
                        map.removeLayer(marker);
                    }
                }, 100);
            });
        }

        function EditLocation(locationId){
            $.ajax({
                url: '/Resources/GetLocation?ID=' + locationId,
                method: 'GET',
                success: function (res) {
                    console.log('GetLocation > res: ', res);
                    for (let key of Object.keys(res)) {
                        $('#' + key).val(res[key]);
                    }
                    $('#locationModal').modal('show');
                    
                    // Handle map for edit
                    $('#locationModal').on('shown.bs.modal', function () {
                        setTimeout(function() {
                            map.invalidateSize();
                            
                            // Add marker for existing coordinates
                            if (res.MapCoordinates) {
                                const [lat, lng] = res.MapCoordinates.split(',');
                                if (marker) {
                                    map.removeLayer(marker);
                                }
                                marker = L.marker([parseFloat(lat), parseFloat(lng)]).addTo(map);
                                map.setView([lat, lng], 13);
                            }
                        }, 100);
                    });
                },
                error: function (err) {
                    alert('Error Getting Data!');
                },
            });
        }

        function DeleteLocation(locationId){
            if(confirm('Do you want to delete this location?')){
                $.ajax({
                    url: '/Resources/DeleteLocation?ID=' + locationId,
                    method: 'GET',
                    success: function (res) {
                        if(res == 1){
                            alert('Location deleted successfully!');
                            window.location.reload();
                        }                    
                    },
                    error: function (err) {
                        alert('Error deleting location!');
                    },
                });
            }
        }

        $(document).ready(function() {
            $('#dataTable').DataTable();
            
            // Initialize map
            initializeMap();

            $('#frmDetails').validate({
                submitHandler: function(form) {
                    IsBusy(true,'Processing...');
                    form.submit();
                }
            });

            $('#btnNewLocation').on('click', function(){
                NewLocation();
            });
        });
    </script>
}